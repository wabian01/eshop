<script type="text/javascript">
    var table_lang = {
        "processing": "Đang xử lý...",
        "aria": {
            "sortAscending": ": Sắp xếp thứ tự tăng dần",
            "sortDescending": ": Sắp xếp thứ tự giảm dần"
        },
        "autoFill": {
            "cancel": "Hủy",
            "fill": "Điền tất cả ô với <i>%d<\/i>",
            "fillHorizontal": "Điền theo hàng ngang",
            "fillVertical": "Điền theo hàng dọc"
        },
        "buttons": {
            "collection": "Chọn lọc <span class=\"ui-button-icon-primary ui-icon ui-icon-triangle-1-s\"><\/span>",
            "colvis": "Hiển thị theo cột",
            "colvisRestore": "Khôi phục hiển thị",
            "copy": "Sao chép",
            "copyKeys": "Nhấn Ctrl hoặc u2318 + C để sao chép bảng dữ liệu vào clipboard.<br \/><br \/>Để hủy, click vào thông báo này hoặc nhấn ESC",
            "copySuccess": {
                "1": "Đã sao chép 1 dòng dữ liệu vào clipboard",
                "_": "Đã sao chép %d dòng vào clipboard"
            },
            "copyTitle": "Sao chép vào clipboard",
            "pageLength": {
                "-1": "Xem tất cả các dòng",
                "_": "Hiển thị %d dòng",
                "1": "Hiển thị 1 dòng"
            },
            "print": "In ấn",
            "createState": "Tạo trạng thái",
            "csv": "CSV",
            "excel": "Excel",
            "pdf": "PDF",
            "removeAllStates": "Xóa hết trạng thái",
            "removeState": "Xóa",
            "renameState": "Đổi tên",
            "savedStates": "Trạng thái đã lưu",
            "stateRestore": "Trạng thái %d",
            "updateState": "Cập nhật"
        },
        "select": {
            "cells": {
                "1": "1 ô đang được chọn",
                "_": "%d ô đang được chọn"
            },
            "columns": {
                "1": "1 cột đang được chọn",
                "_": "%d cột đang được được chọn"
            },
            "rows": {
                "1": "1 dòng đang được chọn",
                "_": "%d dòng đang được chọn"
            }
        },
        "searchBuilder": {
            "title": {
                "_": "Thiết lập tìm kiếm (%d)",
                "0": "Thiết lập tìm kiếm"
            },
            "button": {
                "0": "Thiết lập tìm kiếm",
                "_": "Thiết lập tìm kiếm (%d)"
            },
            "value": "Giá trị",
            "clearAll": "Xóa hết",
            "condition": "Điều kiện",
            "conditions": {
                "date": {
                    "after": "Sau",
                    "before": "Trước",
                    "between": "Nằm giữa",
                    "empty": "Rỗng",
                    "equals": "Bằng với",
                    "not": "Không phải",
                    "notBetween": "Không nằm giữa",
                    "notEmpty": "Không rỗng"
                },
                "number": {
                    "between": "Nằm giữa",
                    "empty": "Rỗng",
                    "equals": "Bằng với",
                    "gt": "Lớn hơn",
                    "gte": "Lớn hơn hoặc bằng",
                    "lt": "Nhỏ hơn",
                    "lte": "Nhỏ hơn hoặc bằng",
                    "not": "Không phải",
                    "notBetween": "Không nằm giữa",
                    "notEmpty": "Không rỗng"
                },
                "string": {
                    "contains": "Chứa",
                    "empty": "Rỗng",
                    "endsWith": "Kết thúc bằng",
                    "equals": "Bằng",
                    "not": "Không phải",
                    "notEmpty": "Không rỗng",
                    "startsWith": "Bắt đầu với",
                    "notContains": "Không chứa",
                    "notEndsWith": "Không kết thúc với",
                    "notStartsWith": "Không bắt đầu với"
                },
                "array": {
                    "equals": "Bằng",
                    "empty": "Trống",
                    "contains": "Chứa",
                    "not": "Không",
                    "notEmpty": "Không được rỗng",
                    "without": "không chứa"
                }
            },
            "logicAnd": "Và",
            "logicOr": "Hoặc",
            "add": "Thêm điều kiện",
            "data": "Dữ liệu",
            "deleteTitle": "Xóa quy tắc lọc",
            "leftTitle": "Giảm thụt lề",
            "rightTitle": "Tăng thụt lề"
        },
        "searchPanes": {
            "countFiltered": "{shown} ({total})",
            "emptyPanes": "Không có phần tìm kiếm",
            "clearMessage": "Xóa hết",
            "loadMessage": "Đang load phần tìm kiếm",
            "collapse": {
                "0": "Phần tìm kiếm",
                "_": "Phần tìm kiếm (%d)"
            },
            "title": "Bộ lọc đang hoạt động - %d",
            "count": "{total}",
            "collapseMessage": "Thu gọn tất cả",
            "showMessage": "Hiện tất cả"
        },
        "datetime": {
            "hours": "Giờ",
            "minutes": "Phút",
            "next": "Sau",
            "previous": "Trước",
            "seconds": "Giây",
            "amPm": [
                "am",
                "pm"
            ],
            "unknown": "-",
            "weekdays": [
                "Chủ nhật"
            ],
            "months": [
                "Tháng Một",
                "Tháng Hai",
                "Tháng Ba",
                "Tháng Tư",
                "Tháng Năm",
                "Tháng Sáu",
                "Tháng Bảy",
                "Tháng Tám",
                "Tháng Chín",
                "Tháng Mười",
                "Tháng Mười Một",
                "Tháng Mười Hai"
            ]
        },
        "emptyTable": "Không có dữ liệu",
        "info": "Hiển thị _START_ tới _END_ của _TOTAL_ dữ liệu",
        "infoEmpty": "Hiển thị 0 tới 0 của 0 dữ liệu",
        "lengthMenu": "Hiển thị _MENU_ dữ liệu",
        "loadingRecords": "Đang tải...",
        "paginate": {
            "first": "Đầu tiên",
            "last": "Cuối cùng",
            "next": "Sau",
            "previous": "Trước"
        },
        "search": "Tìm kiếm:",
        "zeroRecords": "Không tìm thấy kết quả",
        "decimal": ",",
        "editor": {
            "close": "Đóng",
            "create": {
                "button": "Thêm",
                "submit": "Thêm",
                "title": "Thêm mục mới"
            },
            "edit": {
                "button": "Sửa",
                "submit": "Cập nhật",
                "title": "Sửa mục"
            },
            "error": {
                "system": "Đã xảy ra lỗi hệ thống (&lt;a target=\"\\\" rel=\"nofollow\" href=\"\\\"&gt;Thêm thông tin&lt;\/a&gt;)."
            },
            "multi": {
                "info": "Các mục đã chọn chứa các giá trị khác nhau cho đầu vào này. Để chỉnh sửa và đặt tất cả các mục cho đầu vào này thành cùng một giá trị, hãy nhấp hoặc nhấn vào đây, nếu không chúng sẽ giữ lại các giá trị riêng lẻ của chúng.",
                "noMulti": "Đầu vào này có thể được chỉnh sửa riêng lẻ, nhưng không phải là một phần của một nhóm.",
                "restore": "Hoàn tác thay đổi",
                "title": "Nhiều giá trị"
            },
            "remove": {
                "button": "Xóa",
                "confirm": {
                    "_": "Bạn có chắc chắn muốn xóa %d hàng không?",
                    "1": "Bạn có chắc chắn muốn xóa 1 hàng không?"
                },
                "submit": "Xóa",
                "title": "Xóa"
            }
        },
        "infoFiltered": "(được lọc từ _MAX_ dữ liệu)",
        "searchPlaceholder": "Nhập tìm kiếm...",
        "stateRestore": {
            "creationModal": {
                "button": "Thêm",
                "columns": {
                    "search": "Tìm kiếm cột",
                    "visible": "Khả năng hiển thị cột"
                },
                "name": "Tên:",
                "order": "Sắp xếp",
                "paging": "Phân trang",
                "scroller": "Cuộn vị trí",
                "search": "Tìm kiếm",
                "searchBuilder": "Trình tạo tìm kiếm",
                "select": "Chọn",
                "title": "Thêm trạng thái",
                "toggleLabel": "Bao gồm:"
            },
            "duplicateError": "Trạng thái có tên này đã tồn tại.",
            "emptyError": "Tên không được để trống.",
            "emptyStates": "Không có trạng thái đã lưu",
            "removeConfirm": "Bạn có chắc chắn muốn xóa %s không?",
            "removeError": "Không xóa được trạng thái.",
            "removeJoiner": "và",
            "removeSubmit": "Xóa",
            "removeTitle": "Xóa trạng thái",
            "renameButton": "Đổi tên",
            "renameLabel": "Tên mới cho %s:",
            "renameTitle": "Đổi tên trạng thái"
        },
        "infoThousands": ".",
        "thousands": "."
    }
    Vue.component('table-view', {
        template: '#table-view',
        props: ['body_area','object','task','refresh_rate','skip_object','status_ref','list_data_object'],
        data:function(){
            return {
                item_content:"",
                id:"",
                show:false,
                tempFilter:[],
                listFilters:[],
                label:[],
                arrfil:[],
                arrkey:[],
                reset_filter:false,
                filterTable_temp:{},
                stateRule:false,
                apply_filter: false,
                dataStore:'',
                quickfilter:{},
                cancel_filter:false,
            }
        },
        created: function() {
            if(this.body_area.attributes.hasOwnProperty('filterConfig') && this.body_area.attributes.filterConfig.hasOwnProperty('quick')){
                this.quickfilter = {...this.body_area.attributes.filterConfig.quick}
            }
            if(this.object.hasOwnProperty('rule') && this.object.rule.length>0 && typeof(this.object.rule)=='object'){
                this.stateRule = true;
            }
            if(this.body_area.attributes.hasOwnProperty('filters') && this.body_area.attributes.filters.length > 0){
                this.body_area.attributes.filters.forEach(element => {
                    this.arrfil[element.title] = [];
                });
            }
            let id =  Math.random().toString(36).replace(/[^a-z]+/g, '').substr(2, 10);
            this.id = id;
            this.item_content = '<table id=rtaTable-'+id+' class="display nowrap table table-striped table-bordered table-sm" cellspacing="0" width="100%"></table>'
            if(this.task.code===9999){
                let object=this.object;
                for (var screen_code in object.screens) {
                        if (object.screens.hasOwnProperty(screen_code)) {
                            if(screen_code==this.body_area.screenCode){
                                for (var body_code in object.screens[screen_code]['body_area']) {
                                    if (object.screens[screen_code]['body_area'].hasOwnProperty(body_code)) {
                                        if(object.screens[screen_code]['body_area'][body_code].type=='tableView' && object.screens[screen_code]['body_area'][body_code].attributes.hasOwnProperty('filters')){
                                        for(var f =0;f< object.screens[screen_code]['body_area'][body_code].attributes.filters.length;f++){
                                            var filter = object.screens[screen_code]['body_area'][body_code].attributes.filters[f];
                                            filter.code = 'filter-'+makeElemId();
                                            filter.screen_code = screen_code;
                                            if(!filter.hasOwnProperty('entries')){
                                                filter.entries= [];
                                            }
                                            filter.table=object.screens[screen_code]['body_area'][body_code].code;
                                            let check = true;
                                            if(vm.activeListFilters.length>0){
                                                vm.activeListFilters.map(ft=>{
                                                    if(filter.screen_code === ft.screen_code && filter.column === ft.column){
                                                        check = false;
                                                        return;
                                                    }
                                                })
                                                if(check){
                                                    vm.activeListFilters.push(filter);
                                                }
                                            }else{
                                                vm.activeListFilters.push(filter);
                                            }   
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        mounted: function () {
            
        },
        methods: {
            applyFilter: function(){
                this.apply_filter = !this.apply_filter;
                $('#'+this.id).modal('hide');
            },
            cancelFilter: function(){
                $('#'+this.id).modal('hide');
                this.cancel_filter = !this.cancel_filter;
            },
            filterTableview:function(item_filter_attributes,check=false){
                Object.assign(this.filterTable_temp,JSON.parse(item_filter_attributes))
                
                let filter_attributes = this.filterTable_temp
                let temp=[]
                let filter_query=[]
                let filter_query1=[]
                let time
                let json
                Object.keys(filter_attributes).map(function(key){
                    if(filter_attributes[key]=='_all'){
                        return;
                    }
                    if(key.indexOf("date")>-1 || key.indexOf("time")>-1 || ((filter_attributes[key][0].length==24 || filter_attributes[key][0].length==40) && filter_attributes[key][0].indexOf("->")>-1) || filter_attributes[key][0].length==10 && new Date(filter_attributes[key][0])!='Invalid Date'){
                        if(filter_attributes[key][0].indexOf("->")>-1){   
                            let filter_attributes_temp = []
                            filter_attributes_temp[key]=filter_attributes[key][0].split(" -> ");
                            filter_query.push('(moment(item.'+key+').unix()>=moment("'+filter_attributes_temp[key][0]+'").unix() && moment(item.'+key+').unix()<=moment("'+filter_attributes_temp[key][1]+'").unix())')
                        }
                        else if(filter_attributes[key][0].length==10 && new Date(filter_attributes[key][0])!='Invalid Date'){
                            time='((0<= moment(item.'+key+').unix() - moment("'+filter_attributes[key][0]+'").unix() && moment(item.'+key+').unix()-moment("'+filter_attributes[key][0]+'").unix()<=86399 )'
                            for (let i = 1; i < filter_attributes[key].length; i++) {
                                time=time +'|| (0<=moment(item.'+key+').unix()-moment("'+filter_attributes[key][i]+'").unix() && moment(item.'+key+').unix()-moment("'+filter_attributes[key][i]+'").unix()<=86399 )'
                                
                            }
                            time=time +')';
                            filter_query.push(time);
                        }
                        else {
                            filter_query.push('(item.'+key+'=="'+filter_attributes[key].join('" || '+'item.'+key+'=="')+'")')
                        }
                    }else{
                        filter_query.push('(item.'+key+'=="'+filter_attributes[key].join('" || '+'item.'+key+'=="')+'")')
                    }
                    
                })
                filter_query1.push(filter_query.join(' && '))
                if(filter_query1[0]==""){
                    json=this.dataStore;
                }else{
                    json=this.dataStore.filter(function(item) { return eval(filter_query1[0])});
                }
                let data = json;
                
                let data_temp=[];
                let dataSet=[];
                data.forEach(key => {
                    let row2=[];
                    this.body_area.attributes.columns.map(function(table){
                        table.template = vm.aggregateFunction(table.template,key)
                        if(table.template.indexOf('${')===0){
                            row2.push(handleDMFunction(table.template.replace(/##(.*?)##/g,function (match, capture) {
                                let test=jsonPath(key,capture);
                                return test===false?'""':'"'+test+'"';
                            })));
                        }else{
                            row2.push(table.template.replace(/##(.*?)##/g,function (match, capture) {
                                let test=jsonPath(key,capture);
                                return test===false?"":test
                            }));
                        }
                    })
                    dataSet.push(row2);
                })
                if(this.body_area.attributes.layout['hide-header-rows'] === false){
                    var stt = 1;
                    dataSet.forEach(element => {
                        element.unshift(stt)
                        stt = stt + 1;
                    });
                }
                $("#rtaTable-"+this.id).DataTable().clear().draw()
                $("#rtaTable-"+this.id).DataTable().rows.add(dataSet).draw(false)   
            },
            resetFilter: function(id){
               $('#rtaTable-'+id).DataTable().columns().search('').draw()
                this.label = [];
               for(var key in this.arrfil){
                   this.arrfil[key] = [];
               }
            },
            filterTable: function (code,id) {
                this.listFilters =this.body_area.attributes.filters;
            },
            createTag1: function (event,title) {
                    for(var key in this.arrfil){
                       if(key == title ){
                           if(this.arrfil[key].includes(event) != true){
                            this.arrfil[key].push(event);
                           }
                           else{
                            const index = this.arrfil[key].indexOf(event);
                            this.arrfil[key].splice(index,1)
                           }
                            
                        }
                        for(var key1 in this.body_area.attributes.columns){
                            if(this.body_area.attributes.columns[key1].title == title){
                               if(!this.arrkey.includes(key1)){
                                this.arrkey.push(key1)                                
                               }
                            }
                        }
                    }
                    this.arrkey.forEach(col => {
                        var cond = "";
                        var flag = 0;
                        this.arrfil[this.body_area.attributes.columns[col].title].forEach(params => {
                            if(flag==0){
                                cond = params;
                            }
                            else{
                                cond = cond + '|' + params ;
                            }
                            flag++;
                        });
                        $("#rtaTable-"+this.id).DataTable().column(col).search(cond,true,false).draw();
                    });
                    if(this.label.includes(event)){
                        const index = this.label.indexOf(event);
                        this.label.splice(index, 1);
                        this.label=this.label;
                    }
                    else{
                        this.label=this.label.concat(event);  
                    }
            },
            getDataTable: function(ctv,paging,dataSet,columns,columnDefs,order) {
                var that=this;
                var height = "";
                if(this.body_area.attributes['layout'].hasOwnProperty("height") && this.body_area.attributes['layout'].height !== "" && this.body_area.attributes['layout'].height != undefined && this.body_area.attributes['layout'].height != null){
                    if(this.body_area.attributes['layout'].height.toString().indexOf('%')>-1){
                        height = this.body_area.attributes['layout'].height.replace('%',"vh");
                    }else{
                        height = this.body_area.attributes['layout'].height + "px";
                    }
                }
                let language = false;
                if(vm.lang === 'vi'){
                    language = table_lang;
                }
                let table = ctv.DataTable({
                    language: language,
                    scrollX: true,
                    scroller: true,
                    scrollCollapse: true,
                    paging: paging,
                    pageLength: that.body_area.attributes['layout']['rows-per-page'] == undefined ? that.body_area.attributes['layout']['rows-per-page'] : Number(that.body_area.attributes['layout']['rows-per-page']), // rows per page
                    lengthChange: false, 
                    searching: false,
                    data: dataSet,
                    columns: columns,
                    columnDefs: columnDefs,
                    order: order[0],
                });   
                $("#rtaTable-"+that.id+"_wrapper td").css({'height': that.body_area.attributes['layout']['height-cell'] });
                $('.dataTables_paginate.pagination').css({'float':'right'})
                if(height !== '' && parseInt(height)>0){
                    let bodyTab = $("#rtaTable-"+that.id+"_wrapper .dataTables_scrollBody");
                    let bodyTabPa = $("<div class='dataTables_scrollBody_parent'>").insertBefore(bodyTab);
                    bodyTab.appendTo(bodyTabPa);
                    $("#rtaTable-"+that.id+"_wrapper .dataTables_scrollBody_parent").css({'height':height,'overflow':'auto'})
                }
                $("#rtaTable-"+that.id+"_wrapper").css({'padding':'10px'})
                ctv.on( 'page.dt', function () {
                    setTimeout(
                    function() 
                    {

                        $('.dataTables_paginate.pagination').css({'float':'right'})
                        $("#rtaTable-"+that.id+"_wrapper td").css({'height': that.body_area.attributes['layout']['height-cell'] });
                        $(".textAlignCenter").css({'text-align': 'center'  });
                        $(".textAlignLeft").css({'text-align': 'left'  });
                        $(".textAlignRight").css({'text-align': 'right'  });
                    }, 1);
                    
                })
                ctv.on( 'order.dt',  function () { 
                    setTimeout(
                    function() 
                    {
                        $('.dataTables_paginate.pagination').css({'float':'right'})

                        $("#rtaTable-"+that.id+"_wrapper td").css({'height': that.body_area.attributes['layout']['height-cell'] });
                        $(".textAlignCenter").css({'text-align': 'center'  });
                        $(".textAlignLeft").css({'text-align': 'left'  });
                        $(".textAlignRight").css({'text-align': 'right'  });
                    }, 0.05);
                })
                $(".dataTables_filter").hide()
                $(".textAlignCenter").css({'text-align': 'center'  });
                $(".textAlignLeft").css({'text-align': 'left'  });
                $(".textAlignRight").css({'text-align': 'right'  });
                if(!that.body_area.attributes.layout['hide-header-rows']){
                    table.on( 'order.dt search.dt', function () {
                        table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
                            cell.innerHTML = i+1;
                        } );
                    } ).draw();
                }
                ctv.addClass('dm-table-view')
                setTimeout(() => {
                    $('.dm-table-view').DataTable().columns.adjust();
                }, 10);
                let page = 0;
                ctv.DataTable().on('order', function() {
                    if (ctv.DataTable().page() !== page && ctv.DataTable().page.info().pages > page) {
                        ctv.DataTable().page(page).draw('page');
                    }else{
                        page = ctv.DataTable().page();
                    }
                });
                ctv.DataTable().on('page', function() {
                    page = ctv.DataTable().page();
                });
            },
            handleDataObject(){
                let id = this.id;
                let ctv = $("#rtaTable-"+id);
                var object = this.object;
                var body_area = this.body_area;
                var that = this;
                where = 'true';
                var order = "";   
                var get=null;         
                var elasticsearch="";
                let data = JSON.parse(JSON.stringify(this.list_data_object));
                that.dataStore = data;
                        if(Object.keys(that.quickfilter).length>0 && data.length>0){
                            if(!that.quickfilter.hasOwnProperty('entries')){
                                that.quickfilter.entries = []
                                let entries =  data.map(d => jsonPath(d,that.quickfilter.column)[0]);
                                that.quickfilter.entries = that.quickfilter.entries.concat(entries).filter((x, i, d) => d.indexOf(x) == i && x != '');
                            }
                        }
                        vm.activeListFilters.map(function(filter,index) {
                            if(filter.screen_code===that.body_area.screenCode){
                                if((filter.hasOwnProperty('entries') && filter.entries[0]!=undefined && filter.entries[0].toString().indexOf('lite_connection')>-1 ) || filter.hasOwnProperty('check')){
                                    if(!filter.hasOwnProperty('check')){
                                        filter['check'] = filter.entries[0];
                                    }else{
                                        filter.entries = []
                                        filter.entries[0] = filter['check']
                                    }
                                    
                                    let regExp = /\(([^)]+)\)/;
                                    let matches = regExp.exec(filter.entries[0])[1];
                                    if(that.object.lite_connection[matches]!=undefined){
                                        vm.dynamicFilter(that.object.lite_connection[matches],index)
                                    }else{
                                        filter.entries=[];
                                    }
                                }
                                else{
                                    let entries =  data.map(d => d[filter.column]);
                                    if(filter.hasOwnProperty('entries') && filter.entries[0]!=undefined && (filter.entries[0]=='__daterange__' || filter.entries[0]=='__date__' || filter.entries[0]=='__userinput__' || filter.entries[0]=='__datelast__' || filter.entries[0]=='__daterecent__')){
                                        if(filter.entries[0]=='__datelast__' || filter.entries[0]=='__daterecent__') {
                                            filter.timeLast = new Date(Math.max.apply(null, data.map(function(e) {
                                                return new Date(e[filter.column]) == 'Invalid Date' ? 0 : new Date(e[filter.column]);
                                            })));
                                            return
                                        }
                                        filter.entries=[].concat(filter.entries[0])
                                    }else{
                                        filter.entries=[]
                                    }
                                    filter.entries = filter.entries.concat(entries).filter((x, i, d) => d.indexOf(x) == i && x != '');
                                }
                            }
                            return filter;
                        });            
                        var columns = [];
                        var dataSet = [];
                        var nameRow = [];
                        var columnDefs = [];
                        var flag = 0;
                        var positions = [];
                        var paging = true;
                    
                        if(!body_area.attributes.hasOwnProperty('layout')){
                            body_area.attributes['layout'] = {
                                'height': '100%',
                                'rows-per-page': 10,
                                'height-cell': 28,
                                'column-sort': that.object.key_attribute,
                                'order-sort':"ASC",
                                'hide-header-rows':false
                            };
                            paging = false;
                        }else if(!body_area.attributes.layout.hasOwnProperty('hide-header-rows')){
                            body_area.attributes.layout['hide-header-rows'] = false;
                        }

                        if( body_area.attributes.layout['hide-header-rows'] === false){
                            flag = 1;
                        } 
                        if(body_area.attributes['layout'].hasOwnProperty('order-sort') && !body_area.attributes['layout'].hasOwnProperty('column-sort')){
                            body_area.attributes['layout']['column-sort'] = that.object.key_attribute;
                        }
                        else if(!body_area.attributes['layout'].hasOwnProperty('order-sort') && body_area.attributes['layout'].hasOwnProperty('column-sort')){
                            body_area.attributes['layout']['order-sort'] = "ASC";
                        }
                        else if(!body_area.attributes['layout'].hasOwnProperty('order-sort') && !body_area.attributes['layout'].hasOwnProperty('column-sort')){
                            body_area.attributes['layout']['column-sort'] = that.object.key_attribute;
                            body_area.attributes['layout']['order-sort'] = "ASC";
                        }           
                        for(var key in body_area.attributes.layout){
                            if(body_area.attributes.layout[key] == '-1'){
                                if(key == 'height'){
                                    body_area.attributes.layout[key] = '100%';
                                }
                                else if(key == 'rows-per-page'){
                                    body_area.attributes.layout[key] = '10';
                                    paging = false;
                                }
                            }
                        }
                        body_area.attributes.columns.forEach(element => {
                            var temp = { title: element.title };
                            columns.push(temp);
                            var cell = {};
                            if(element.type === 'image'){
                                
                                positions.push(flag);
                                cell = {
                                    "targets": flag, 
                                    "render": function (data, type, row) {
                                        var position = positions[0];
                                        let style = ''
                                        if(element.textAlign === 'center'){
                                            style+= 'margin: 0 auto;'
                                        }
                                        else if(element.textAlign === 'right'){
                                            style+= 'float:right;'
                                        }
                                        return '<div style="width:100px;height:100px;'+style+'"><img src="'+row[position]+'" onerror="this.onerror=null;this.src=\'./metronic6/images/rta_nophoto.webp\';" style="width:100px;height:100px"></div>';
                                    }
                                }
                                if(element.textAlign === 'center'){
                                    cell['className'] = "textAlignCenter";
                                }
                                else if(element.textAlign === 'left'){
                                    cell['className'] = "textAlignLeft";
                                }
                                else{
                                    cell['className'] = "textAlignRight";
                                }
                            }
                            else{
                                if(element.textAlign === 'center'){
                                    cell['targets'] = flag;
                                    cell['className'] = "textAlignCenter";
                                }
                                else if(element.textAlign === 'left'){
                                    cell['targets'] = flag;
                                    cell['className'] = "textAlignLeft";
                                }
                                else{
                                    cell['targets'] = flag;
                                    cell['className'] = "textAlignRight";
                                }
                            }
                            columnDefs.push(cell);
                            var order = "";

                            for(var key in data[0]){
                                if(element.template.indexOf('$') == -1 && element.template.indexOf("##"+key+"##")!== -1){
                                    nameRow.push(key)
                                }
                                else if(element.template.indexOf('$') > -1){ // support ES
                                    let template_temp = JSON.parse(JSON.stringify(element.template)).replaceAll('##','').split('.')[1]
                                    if(key == template_temp){
                                        nameRow.push(JSON.parse(JSON.stringify(element.template)).replaceAll('##',''))
                                    }
                                }
                            }
                            flag = flag + 1;
                        });
                        var order = [];
                        for(var i = 0;i<nameRow.length;i++){
        
                            if(nameRow[i] == body_area.attributes['layout']['column-sort'].replaceAll('##','')){
                                if(!body_area.attributes.layout['hide-header-rows']){
                                    order.push([i+1, body_area.attributes['layout']['order-sort'].toLowerCase()]);
                                }
                                else{
                                    order.push([i, body_area.attributes['layout']['order-sort'].toLowerCase()]);
                                }
                                
                            }
                            
                        }
                        data.forEach(key => {
                            let row2=[];
                            body_area.attributes.columns.map(function(table){
                                let value_template = vm.aggregateFunction(table.template,key)
                                if(value_template.indexOf('${')===0){
                                    row2.push(handleDMFunction(value_template.replace(/##(.*?)##/g,function (match, capture) {
                                        let test=jsonPath(key,capture);
                                        return test===false?'""':'"'+test+'"';
                                    })));
                                }else{
                                    row2.push(value_template.replace(/##(.*?)##/g,function (match, capture) {
                                        let test=jsonPath(key,capture);
                                        return test===false?'':test;
                                    }));
                                }
                            })
                            dataSet.push(row2);
                        })

                        
                        if( body_area.attributes.layout['hide-header-rows'] === false){
                            var stt = 1;
                            dataSet.forEach(element => {
                                element.unshift(stt)
                                stt = stt + 1;
                                
                            });    
                            columns.unshift({title : 'No'});
                            columnDefs.push({ orderable: false, targets: 0 })
                        }       
                        that.getDataTable(ctv,paging,dataSet,columns,columnDefs,order);
            },
            refreshRate: function(){
                
                let object = this.object;
                let body_area = this.body_area;
                let that = this;
                where = 'true';
                let order = "";   
                let get=null;         
                let elasticsearch="";

                if (typeof  object.query_params != 'undefined' && object.query_params != null) {
                    if (typeof  object.query_params.where != 'undefined' && object.query_params.where != null) {
                        if (where == "true") {
                            where = object.query_params.where;
                        }
                    }
                    if (typeof  object.query_params.get != 'undefined' && object.query_params.get != null) {
                            get = object.query_params.get;
                    }
                    if(typeof  object.query_params.post_body != 'undefined' && object.query_params.post_body != null){
                            elasticsearch = object.query_params.post_body;
                    }
                }
               if(this.task.hasOwnProperty('where') != -1 && this.task.where != null && this.task.where.length > 0){
                    if(where != 'true'){
                        where = '(' + where + ') AND ' + this.task.where
                    }
                    else{
                        where = this.task.where
                    }
                }
                if(this.task.hasOwnProperty('get') != -1 && this.task.get != null){
                    if(get != null){
                        Object.assign(get,this.task.get)
                    }
                    else{
                        get = this.task.get
                    }
                }
                if(this.body_area.hasOwnProperty('filterConfig')&&Object.keys(this.body_area.filterConfig).length > 0){
                    order = "`"+this.body_area.filterConfig['sortCol']+"` "+this.body_area.filterConfig['order']+"";
                }
                else{
                    order = "`"+this.object.key_attribute+"` ASC";
                }
                if(this.task.hasOwnProperty('post') && this.task.post != null){
                    elasticsearch = this.task.post;
                }
                if(object.dm_type == "Elasticsearch" && get != null && get !== "" && typeof(get) =='string'){
                    get=JSON.parse(get);
                }
                if(object.dm_type == "Elasticsearch" && elasticsearch != "" && typeof(elasticsearch) == 'string'){
                    elasticsearch=JSON.parse(elasticsearch)
                }
                $.ajax({
                    url:that.object.dm_host + (that.object.dm_type=="V1" ? '/api/download/query' : that.object.dm_type=="V2" ? "/api/dm/getData" : that.object.dm_type=="Chained" ? '/api/dm/getChainedData' :  "/" +that.object.dm_name + '/_search'),
                    type: (that.object.dm_type == "Elasticsearch" &&  elasticsearch !="" ) ? 'POST' : 'GET',
                    dataType:'json',
                    contentType: (that.object.dm_type == "Elasticsearch" &&  elasticsearch != "" ) ? 'application/json' : false,
                    data:(that.object.dm_type=="V1" || that.object.dm_type=="V2") ? 
                    {
                        token:that.object.token,
                        dm_name:that.object.dm_name,
                        where:where,
                        download:0,
                        mode:'query',
                        format:'json',
                        ...get
                    }: that.object.dm_type=="Chained" ?
                    {
                        chain_name:that.object.dm_name,
                        token:that.object.token,
                        type:'group',
                        begin_at:'root',
                        conditions:where,
                        ...get
                    } : (that.object.dm_type == "Elasticsearch" &&  elasticsearch !="" ) ? JSON.stringify(elasticsearch) : {...get},
                    success:function (data) {  
                        if( (that.object.dm_type=="Elasticsearch" && !that.object.hasOwnProperty('data_path')) || (that.object.dm_type=="Elasticsearch" && that.object.hasOwnProperty('data_path') && (that.object.data_path=='' || that.object.data_path==null))){
                            let elasticsearch_data=JSON.parse(JSON.stringify(data));
                            data=jsonPath(elasticsearch_data,'hits.hits[*]._source')
                        }
                        if(that.object.dm_type=="Elasticsearch" && that.object.hasOwnProperty('data_path') && that.object.data_path!='' && that.object.data_path!=null){
                            let elasticsearch_data=JSON.parse(JSON.stringify(data));
                            data=jsonPath(elasticsearch_data.aggregations,that.object.data_path)
                        }
                        if(that.stateRule){
                            vm.configRule(data,that.object.rule)
                        }
                        vm.activeListFilters.map(function(filter,index) {
                            if(filter.screen_code===that.body_area.screenCode){
                                if((filter.hasOwnProperty('entries') && filter.entries[0]!=undefined && filter.entries[0].toString().indexOf('lite_connection')>-1 ) || filter.hasOwnProperty('check')){
                                    if(!filter.hasOwnProperty('check')){
                                        filter['check'] = filter.entries[0];
                                    }else{
                                        filter.entries = []
                                        filter.entries[0] = filter['check']
                                    }
                                    
                                    let regExp = /\(([^)]+)\)/;
                                    let matches = regExp.exec(filter.entries[0])[1];
                                    if(that.object.lite_connection[matches]!=undefined){
                                        vm.dynamicFilter(that.object.lite_connection[matches],index)
                                    }else{
                                        filter.entries=[];
                                    }
                                }
                                else{
                                    let entries =  data.map(d => d[filter.column]);
                                    if(filter.hasOwnProperty('entries') && filter.entries[0]!=undefined && (filter.entries[0]=='__daterange__' || filter.entries[0]=='__date__' || filter.entries[0]=='__userinput__' || filter.entries[0]=='__datelast__' || filter.entries[0]=='__daterecent__')){
                                        if(filter.entries[0]=='__datelast__' || filter.entries[0]=='__daterecent__') {
                                            filter.timeLast = new Date(Math.max.apply(null, data.map(function(e) {
                                                return new Date(e[filter.column]) == 'Invalid Date' ? 0 : new Date(e[filter.column]);
                                            })));
                                            return
                                        }
                                        filter.entries=[].concat(filter.entries[0])
                                    }else{
                                        filter.entries=[]
                                    }
                                    filter.entries = filter.entries.concat(entries).filter((x, i, d) => d.indexOf(x) == i && x != '');
                                }
                            }
                            return filter;
                        }); 
                        let page1 = $("#rtaTable-"+that.id).DataTable().page.info().page;
                        let scroll1 = $("#rtaTable-"+that.id+"_wrapper .dataTables_scrollBody").scrollTop();
                      
                        let data1=JSON.stringify(data)
                            let data_temp=[];
                            let dataSet=[];
                          data.forEach(key => {
                            let row2=[];
                            that.body_area.attributes.columns.map(function(table){
                                let value_template = vm.aggregateFunction(table.template,key)
                                if(value_template.indexOf('${')===0){
                                    row2.push(handleDMFunction(value_template.replace(/##(.*?)##/g,function (match, capture) {
                                        let test=jsonPath(key,capture);
                                        return test===false?'""':'"'+test+'"';
                                    })));
                                }else{
                                    value_template.replace(/##(.*?)##/g,function (match, capture) {
                                        let test=jsonPath(key,capture);
                                        row2.push(test===false?"":test)
                                    });
                                }
                            })
                            dataSet.push(row2);
                        })
                        if(that.body_area.attributes.layout['hide-header-rows'] === false){
                            var stt = 1;
                            dataSet.forEach(element => {
                                element.unshift(stt)
                                stt = stt + 1;
                            });
                        }
                        $("#rtaTable-"+that.id).DataTable().clear().draw()
                        $("#rtaTable-"+that.id).DataTable().rows.add(dataSet).draw(false)
                        $("#rtaTable-"+that.id).DataTable().page(page1).draw('page')
                        $("#rtaTable-"+that.id+"_wrapper .dataTables_scrollBody").scrollTop(scroll1);
                        
                    }
                });
            }
        },
        watch: {
            list_data_object(list_data_object_new,list_data_object_old){
                if(list_data_object_old==="waiting_loading"){
                    this.handleDataObject()
                }
            },
            status_ref(value){},
            refresh_rate:  function(value){},
        }   
    })
</script>